name: Build sing-box ruleset
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"
      - "**/*.ini"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          echo "domains_download_url=https://github.com/DustinWin/domain-list-custom/releases/download/domains" >> ${GITHUB_ENV}
          echo "ips_download_url=https://github.com/DustinWin/geoip/releases/download/ips" >> ${GITHUB_ENV}
        shell: bash

      - name: Clone Repository
        uses: actions/checkout@v6

      - name: Download rule source files
        run: |
          mkdir -p ./tools/rules/ ./tmp/
          domains=(private ads trackerslist microsoft-cn apple-cn google-cn games-cn netflix disney max primevideo appletv youtube tiktok bilibili spotify media games ai networktest tld-proxy gfw proxy cn cn-lite)
          ips=(netflixip mediaip gamesip privateip cnip telegramip)

          for domain in "${domains[@]}"; do
            mkdir -p "./tools/rules/${domain}/"
            curl -sSL "${domains_download_url}/${domain}.list" > "./tools/rules/${domain}/${domain}.list"
          done

          mkdir -p ./tools/rules/fakeip-filter/
          # Use printf for better YAML compatibility and avoid heredoc indentation issues
          printf "DOMAIN-KEYWORD,ntp\nDOMAIN-KEYWORD,stun\nDOMAIN-KEYWORD,time\n" > ./tmp/temp-fakeip-filter-rules.txt
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '!/(DOMAIN-REGEX,|ntp|stun|time)/' >> ./tmp/temp-fakeip-filter-rules.txt
          sort --ignore-case ./tmp/temp-fakeip-filter-rules.txt > ./tools/rules/fakeip-filter/fakeip-filter.list

          mkdir -p ./tools/rules/fakeip-filter-lite/
          printf "DOMAIN-KEYWORD,ntp\nDOMAIN-KEYWORD,stun\nDOMAIN-KEYWORD,time\n" > ./tmp/temp-fakeip-filter-lite-rules.txt
          sort --ignore-case ./tmp/temp-fakeip-filter-lite-rules.txt > ./tools/rules/fakeip-filter-lite/fakeip-filter-lite.list

          mkdir -p ./tools/rules/applications/
          curl -sSL "${domains_download_url}/applications.list" > "./tools/rules/applications/applications.list"

          for ip in "${ips[@]}"; do
            mkdir -p "./tools/rules/${ip}/"
            curl -sSL "${ips_download_url}/${ip}.list" > "./tools/rules/${ip}/${ip}.list"
          done
          rm -rf ./tmp*

      - name: Generate `sing-box` rule_set (srs)
        run: |
          LATEST_TAG=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.tag_name')
          LATEST_VERSION=${LATEST_TAG#v}
          echo "singbox_core_new_version=${LATEST_VERSION}" >> $GITHUB_ENV

          # Use a more robust download and extraction logic
          mkdir -p ./tools/sb_bin/
          curl -L "https://github.com/SagerNet/sing-box/releases/download/${LATEST_TAG}/sing-box-${LATEST_VERSION}-linux-amd64.tar.gz" | tar -zx -C ./tools/sb_bin/
          find ./tools/sb_bin/ -name "sing-box" -type f -exec mv {} ./tools/sing-box \;
          rm -rf ./tools/sb_bin/
          
          mkdir -p ./sing-box-ruleset/
          cd ./tools/
          # Ensure rule-set version is 2
          sed -i 's/"version": [1-9]*/"version": 2/' ./convert.sh
          # Fix potential line ending issues
          sed -i 's/\r$//' ./convert.sh
          chmod +x ./convert.sh && ./convert.sh
          # Move only srs files
          mv -f ./*.srs ../sing-box-ruleset/
          rm -rf ./rules*

      - name: Release and upload `sing-box-ruleset` assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: sing-box-ruleset
          tag: sing-box-ruleset
          overwrite: true
          body: |
            sing-box rule_set (.srs)
            Core: v${{ env.singbox_core_new_version }}
            Update: ${{ env.update_version }}
          file_glob: true
          file: ./sing-box-ruleset/*

      - name: Commit and push `sing-box-ruleset` branch
        run: |
          rm -rf ./tmp_push/
          mkdir ./tmp_push/
          cp -r ./sing-box-ruleset/* ./tmp_push/
          cd ./tmp_push/
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b sing-box-ruleset
          git add .
          git commit -m "sing-box rule_set update at ${{ env.update_version }}"
          # Use force push to the specific branch
          git push -f "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" sing-box-ruleset
